<!DOCTYPE html>
<html lang="en">

    <head>
        <title></title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.css">
        
        
        <%- include('../partials/head'); %>
    </head>
    <body>
        <header>
            <%- include('../partials/adminHeader'); -%>
        </header>

        <main>
            <div class="container">
                <br>
                <table class="table" id="myTable">
                    <thead>
                      <tr>
                        <th scope="col">Title</th>
                        <th scope="col">Description</th>
                        <th scope="col">Published At</th>
                        <th scope="col">Edit/Delete</th>
                      </tr>
                    </thead>
                    <tbody>
                        <% for(var i=0; i<data.length; i++) { %>
                        <tr>
                            <th><%= data[i].title %></th>
                            <td><%= data[i].description %></td>
                            <td><%= data[i].publishedat %></td>
                            <td>
                                <button data-target="#myModal" id="<%=data[i]._id%>" type="button" class="update btn btn-warning" data-toggle="modal">
                                    Edit
                                </button>
                                <button type="button" class="delete btn btn-danger" id="<%=data[i]._id%>">
                                    Delete
                                </button>
                            </td>
                        </tr>
                      <% } %>


                      <div class="modal" id="myModal">
                        <div class="modal-dialog">
                        <div class="modal-content">
                            
                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title">User</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                    
                            <!-- Modal body -->
                            <div class="modal-body">
                                <form action="/update_news" method="POST" id="update_news">
                                    <div class="form-group">
                                            <label for="id" >ID</label>
                                            <input type="text" id="update_id" name="id" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="title" >Title</label>
                                        <input type="text" id="update_title" name="title" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="description" >Description</label>
                                        <input type="text" id="update_description" name="description" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="url">Url</label>
                                        <input type="text" id="update_url" name="url" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="urlToImage" >Url To Image</label>
                                        <input type="text" id="update_urlToImage" name="urlToImage" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="publishedAt" >Published At</label>
                                        <input type="text" id="update_publishedAt" name="publishedAt" class="form-control" required />
                                    </div>
                                </form>
                            </div>
                    
                            <!-- Modal footer -->
                            <div class="modal-footer">
                                    
                                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                    <button type="submit" id="update_table" class="btn btn-primary">Update</button>
                            </div>
                        </div>
                        </div>
                        </div>


                    </tbody>
                  </table>
            </div>
        </main>

        <footer>
            <%- include('../partials/footer'); -%>
        </footer>

    </body>

      
    <script>
        $(document).ready( function () {
            $('#myTable').DataTable();
        });  
        
        $('.update').click(function() {
        id= this.id;
        console.log('id is '+id)
        $.ajax({
            type: 'POST',
            url: '/admin/find_by_id',
            data: {id},
            success: function(data){
                    $("#update_id").attr("value", data[0]._id)
                    $("#update_title").attr("value", data[0].title);
                    $("#update_description").attr("value", data[0].description);
                    $("#update_url").attr("value", data[0].url);
                    $("#update_urlToImage").attr("value", data[0].url_to_image);
                    $("#update_publishedAt").attr("value", data[0].publishedat);
                    $('#myModal').modal({show: true});
            },
            error: function(){
                alert('No data');
            }
        });
    });
    
    $(function(){
        $('#update_table').on('click', function(e){
            var data = $('#update_news').serialize();
            //console.log(">>>>>", data)
            //e.preventDefault();
            $.ajax({
                url: '/admin/updateNews',
                type:'PUT',
                data : data,
                success: function(data){
                    // Reloads the current page from the server (default: reload from cache)
                    location.reload({forceGet:true})
                },
                error: function(err){
                    console.log("#update_table : err : ", err)
                }
            });
            $('#myModal .close').click()   
        });
    });


    $('.delete').click(function() {
        //var response = confirm("do you want to delete")
        id = this.id;
        //console.log(response)
        //if(response === true){
            $.ajax({
                type: 'DELETE',
                url: '/admin/deleteNews',
                method: 'delete',
                data: {id},
                success: function(data){
                    //console.log('data is '+JSON.stringify(data));                   
                    // Reloads the current page from the server (default: reload from cache)
                    location.reload({forceGet:true})
                },
                error: function(err){
                    alert(err);
                }
            });
        //}
        //else{
        //    console.log("Cancelled Delete")
        //}
    });       


    </script>

</html>